# Маппинг SNI -> upstream
map $ssl_preread_server_name $backend {
    # Для Xray Reality
    ~^xray\. xray;
    
    # Для панели и прокси - обычный HTTPS
    default https_backend;
}

# Upstream для Xray Reality
upstream xray {
    server 3x-ui:8443;
}

# Upstream для обычного HTTPS (панель, прокси)
upstream https_backend {
    server 127.0.0.1:8443;
}

# Основной сервер на 443 с SNI routing
server {
    listen 443 reuseport;
    listen [::]:443 reuseport;
    
    proxy_pass $backend;
    ssl_preread on;
}
